CREATE OR REPLACE PROCEDURE HDIS_SBX.SBX_LOREN_HARDY.REFRESH_DQ_DETAIL_QA()
RETURNS VARCHAR
LANGUAGE SQL
EXECUTE AS OWNER
AS '
BEGIN

-- Truncate dq_detail_qa table
TRUNCATE TABLE dq_detail_qa;

--INSERT data into dq_detail_qa table using query
INSERT INTO dq_detail_qa (filename, dataelement, id_field_1, id_value_1, id_field_2, id_value_2, id_field_3, id_value_3, pstg_row_id, source_file, error_message, descr, error_type, date_loaded, PRIORITIZATION)
with error_tbl as (
select a.*, PRIORITIZATION from hdis_dev.staging.error_tbl_2 a
join HDIS_DEV.STAGING.CTRL_VALIDATION b on a.query_name = b.query_name
where error_date_value >= DATEADD(YEAR, - 1, DATE_TRUNC(''quarter'', DATEADD(''quarter'', - 4, CURRENT_DATE))) AND (YEAR(error_date_value) < YEAR(CURRENT_DATE) OR (YEAR(error_date_value) = YEAR(CURRENT_DATE) AND QUARTER(error_date_value) <= QUARTER(CURRENT_DATE)))),
enrollment as (
select distinct enrollment_id, source_file, personal_id, project_id, pstg_row_id, disabling_condition, entry_date, stg_md5_hash_value, relationship_to_hoh, living_situation, length_of_stay from hdis_dev.staging.pstg_enrollment where 
coalesce(try_to_date(entry_date), CURRENT_TIMESTAMP) >= DATEADD(YEAR, - 1, DATE_TRUNC(''quarter'', DATEADD(''quarter'', - 4, CURRENT_DATE))) AND (YEAR(coalesce(try_to_date(entry_date), CURRENT_TIMESTAMP)) < YEAR(CURRENT_DATE) OR (YEAR(coalesce(try_to_date(entry_date), CURRENT_TIMESTAMP)) = YEAR(CURRENT_DATE) AND QUARTER(coalesce(try_to_date(entry_date), CURRENT_TIMESTAMP)) <= QUARTER(CURRENT_DATE)))
),
base as (
SELECT 
''INVENTORY.CSV'' fileName 
,''ALL'' DataElement
,case when a.inventory_id is null then ''STG_MD5_HASH_VALUE'' else ''INVENTORY_ID'' end ID_FIELD_1
,case when a.inventory_id is null then a.stg_md5_hash_value else a.inventory_id end ID_VALUE_1
,case when a.project_id is null then ''STG_MD5_HASH_VALUE'' else ''PROJECT_ID'' end ID_FIELD_2
,case when a.project_id is null then a.stg_md5_hash_value else a.project_id end ID_VALUE_2
,NULL ID_FIELD_3
,NULL ID_VALUE_3
,a.pstg_row_id
,a.source_file
,c.error_message
,c.descr
,''INVALID RESPONSE'' error_type
,current_date() as date_loaded
, PRIORITIZATION
FROM hdis_dev.staging.pstg_inventory a
JOIN error_tbl c ON (coalesce(a.inventory_id||''|''||a.project_id||''|''||a.coc_code||''|''||a.household_type,a.stg_md5_hash_value)) = c.business_key_value and a.source_file = c.source_file and c.table_name like ''PSTG_INVENTORY'' and query_name not in (''INVENTORY_1'', ''INVENTORY_7'', ''INVENTORY_8'', ''INVENTORY_9'', ''INVENTORY_10'', ''INVENTORY_21'', ''INVENTORY_22'', ''INVENTORY_23'', ''INVENTORY_24'', ''INVENTORY_38'', ''INVENTORY_39'', ''INVENTORY_45'', ''INVENTORY_46'', ''INVENTORY_47'', ''INVENTORY_48'', ''INVENTORY_49'')


UNION ALL

SELECT 
''PROJECT.CSV'' fileName
,''ALL'' DataELement
,case when a.project_id is null then ''STG_MD5_HASH_VALUE'' else ''PROJECT_ID'' end ID_FIELD_1
,case when a.project_id is null then a.stg_md5_hash_value else a.project_id end ID_VALUE_1
,NULL ID_FIELD_2
,NULL ID_VALUE_2
,NULL ID_FIELD_3
,NULL ID_VALUE_3
,a.pstg_row_id
,a.source_file
,b.error_message
,b.descr
,''INVALID RESPONSE'' ERROR_TYPE
,current_date() as date_loaded, PRIORITIZATION
FROM hdis_dev.staging.pstg_project a
JOIN error_tbl B ON coalesce(a.project_id,a.stg_md5_hash_value) = B.business_key_value and a.source_file = b.source_file and table_name like ''PSTG_PROJECT'' and query_name NOT IN (''PROJECT_28'', ''PROJECT_39'', ''PROJECT_10'', ''PROJECT_40'', ''PROJECT_7'', ''PROJECT_41'', ''PROJECT_29'', ''PROJECT_6'', ''PROJECT_5'', ''PROJECT_30'', ''PROJECT_43'', ''PROJECT_44'') 

UNION ALL

SELECT 
''CLIENT.CSV'' fileName
,''NAME'' DataElement
,case when a.personal_id is null then ''STG_MD5_HASH_VALUE'' else ''PERSONAL_ID'' end ID_FIELD_1
,case when a.personal_id is null then a.stg_md5_hash_value else a.personal_id end ID_VALUE_1
,NULL ID_FIELD_2
,NULL ID_VALUE_2
,NULL ID_FIELD_3
,NULL ID_VALUE_3
,a.pstg_row_id
,a.source_file
,error_message
,descr
,''INVALID RESPONSE'' ERROR_TYPE
,current_date() as date_loaded, PRIORITIZATION
FROM hdis_dev.staging.pstg_client a
join enrollment en on a.personal_id = en.personal_id and a.source_file = en.source_file
JOIN error_tbl b ON coalesce(a.personal_id, a.stg_md5_hash_value) = b.business_key_value and a.source_file = b.source_file and b.query_name in (''CLIENT_50'', ''CLIENT_51'', ''CLIENT_52'', ''CLIENT_27'')

UNION ALL

SELECT 
''CLIENT.CSV'' fileName
,''NAME'' DataElement
,case when a.personal_id is null then ''STG_MD5_HASH_VALUE'' else ''PERSONAL_ID'' end ID_FIELD_1
,case when a.personal_id is null then a.stg_md5_hash_value else a.personal_id end ID_VALUE_1
,NULL ID_FIELD_2
,NULL ID_VALUE_2
,NULL ID_FIELD_3
,NULL ID_VALUE_3
,a.pstg_row_id
,a.source_file
,CASE WHEN NAME_DATA_QUALITY = 99 THEN ''DATA NOT COLLECTED INDICATED FOR NAME_DATA_QUALITY FIELD''
WHEN NAME_DATA_QUALITY IN (8,9) THEN ''CLIENT DOESN''''T KNOW OR PREFERS NOT TO ANSWER INDICATED FOR NAME_DATA_QUALITY FIELD.'' END AS error_message
,CASE WHEN NAME_DATA_QUALITY = 99 THEN ''NAME_DATA_QUALITY = 99''
WHEN NAME_DATA_QUALITY IN (8,9) THEN ''NAME_DATA_QUALITY IN (8,9)'' END AS descr
,CASE WHEN NAME_DATA_QUALITY = 99 THEN ''DATA NOT COLLECTED''
WHEN NAME_DATA_QUALITY IN (8,9) THEN ''CLIENT DOESN''''T KNOW'' END AS ERROR_TYPE
,current_date() as date_loaded, '''' PRIORITIZATION
FROM hdis_dev.staging.pstg_client a
join enrollment en on a.personal_id = en.personal_id and a.source_file = en.source_file
WHERE ERROR_TYPE IS NOT NULL

UNION ALL

SELECT 
''CLIENT.CSV'' fileName
,''SSN'' DataElement
,case when a.personal_id is null then ''STG_MD5_HASH_VALUE'' else ''PERSONAL_ID'' end ID_FIELD_1
,case when a.personal_id is null then a.stg_md5_hash_value else a.personal_id end ID_VALUE_1
,NULL ID_FIELD_2
,NULL ID_VALUE_2
,NULL ID_FIELD_3
,NULL ID_VALUE_3
,a.pstg_row_id
,a.source_file
,error_message
,descr
,''INVALID RESPONSE'' ERROR_TYPE
,current_date() as date_loaded, PRIORITIZATION
FROM hdis_dev.staging.pstg_client a
join enrollment en on a.personal_id = en.personal_id and a.source_file = en.source_file
JOIN error_tbl b ON coalesce(a.personal_id, a.stg_md5_hash_value) = b.business_key_value and a.source_file = b.source_file and b.query_name in (''CLIENT_54'', ''CLIENT_2'')

UNION ALL

SELECT 
''CLIENT.CSV'' fileName
,''SSN'' DataElement
,case when a.personal_id is null then ''STG_MD5_HASH_VALUE'' else ''PERSONAL_ID'' end ID_FIELD_1
,case when a.personal_id is null then a.stg_md5_hash_value else a.personal_id end ID_VALUE_1
,NULL ID_FIELD_2
,NULL ID_VALUE_2
,NULL ID_FIELD_3
,NULL ID_VALUE_3
,a.pstg_row_id
,a.source_file
,CASE WHEN SSN_DATA_QUALITY = 99 THEN ''DATA NOT COLLECTED INDICATED FOR SSN_DATA_QUALITY FIELD''
WHEN SSN_DATA_QUALITY IN (8,9) THEN ''CLIENT DOESN''''T KNOW OR PREFERS NOT TO ANSWER INDICATED FOR SSN_DATA_QUALITY FIELD.'' END AS error_message
,CASE WHEN SSN_DATA_QUALITY = 99 THEN ''SSN_DATA_QUALITY = 99''
WHEN SSN_DATA_QUALITY IN (8,9) THEN ''SSN_DATA_QUALITY IN (8,9)'' END AS descr
,CASE WHEN SSN_DATA_QUALITY = 99 THEN ''DATA NOT COLLECTED''
WHEN SSN_DATA_QUALITY IN (8,9) THEN ''CLIENT DOESN''''T KNOW'' END AS ERROR_TYPE
,current_date() as date_loaded, '''' PRIORITIZATION
FROM hdis_dev.staging.pstg_client a
join enrollment en on a.personal_id = en.personal_id and a.source_file = en.source_file
WHERE ERROR_TYPE IS NOT NULL 

UNION ALL

SELECT 
''CLIENT.CSV'' fileName
,''DOB'' DataElement
,case when a.personal_id is null then ''STG_MD5_HASH_VALUE'' else ''PERSONAL_ID'' end ID_FIELD_1
,case when a.personal_id is null then a.stg_md5_hash_value else a.personal_id end ID_VALUE_1
,NULL ID_FIELD_2
,NULL ID_VALUE_2
,NULL ID_FIELD_3
,NULL ID_VALUE_3
,a.pstg_row_id
,a.source_file
,error_message
,descr
,''INVALID RESPONSE'' ERROR_TYPE
,current_date() as date_loaded, PRIORITIZATION
FROM hdis_dev.staging.pstg_client a
join enrollment en on a.personal_id = en.personal_id and a.source_file = en.source_file
JOIN error_tbl b ON coalesce(a.personal_id, a.stg_md5_hash_value) = b.business_key_value and a.source_file = b.source_file and query_name IN (''CLIENT_125'', ''CLIENT_126'', ''CLIENT_120'')

UNION ALL 

SELECT 
''CLIENT.CSV'' fileName
,''DOB'' DataElement
,case when a.personal_id is null then ''STG_MD5_HASH_VALUE'' else ''PERSONAL_ID'' end ID_FIELD_1
,case when a.personal_id is null then a.stg_md5_hash_value else a.personal_id end ID_VALUE_1
,NULL ID_FIELD_2
,NULL ID_VALUE_2
,NULL ID_FIELD_3
,NULL ID_VALUE_3
,a.pstg_row_id
,a.source_file
,CASE WHEN DOB_DATA_QUALITY = 99 THEN ''DATA NOT COLLECTED INDICATED FOR DOB_DATA_QUALITY FIELD''
WHEN DOB_DATA_QUALITY IN (8,9) THEN ''CLIENT DOESN''''T KNOW OR PREFERS NOT TO ANSWER INDICATED FOR DOB_DATA_QUALITY FIELD.'' END AS error_message
,CASE WHEN DOB_DATA_QUALITY = 99 THEN ''DOB_DATA_QUALITY = 99''
WHEN DOB_DATA_QUALITY IN (8,9) THEN ''DOB_DATA_QUALITY IN (8,9)'' END AS descr
,CASE WHEN DOB_DATA_QUALITY = 99 THEN ''DATA NOT COLLECTED''
WHEN DOB_DATA_QUALITY IN (8,9) THEN ''CLIENT DOESN''''T KNOW'' END AS ERROR_TYPE
,current_date() as date_loaded, '''' PRIORITIZATION
FROM hdis_dev.staging.pstg_client a
join enrollment en on a.personal_id = en.personal_id and a.source_file = en.source_file
WHERE ERROR_TYPE IS NOT NULL 

UNION ALL 

SELECT 
''CLIENT.CSV'' fileName
,''GENDER'' DataElement
,case when a.personal_id is null then ''STG_MD5_HASH_VALUE'' else ''PERSONAL_ID'' end ID_FIELD_1
,case when a.personal_id is null then a.stg_md5_hash_value else a.personal_id end ID_VALUE_1
,NULL ID_FIELD_2
,NULL ID_VALUE_2
,NULL ID_FIELD_3
,NULL ID_VALUE_3
,a.pstg_row_id
,a.source_file
,error_message
,descr
,''INVALID RESPONSE'' ERROR_TYPE
,current_date() as date_loaded, PRIORITIZATION
FROM hdis_dev.staging.pstg_client a
join enrollment en on a.personal_id = en.personal_id and a.source_file = en.source_file
JOIN error_tbl b ON coalesce(a.personal_id, a.stg_md5_hash_value) = b.business_key_value and a.source_file = b.source_file and query_name IN (''CLIENT_11'', ''CLIENT_66'', ''CLIENT_12'', ''CLIENT_67'', ''CLIENT_13'',''CLIENT_68'', ''CLIENT_24'', ''CLIENT_69'',''CLIENT_70'', ''CLIENT_14'',''CLIENT_71'', ''CLIENT_15'', ''CLIENT_72'', ''CLIENT_25'', ''CLIENT_16'',''CLIENT_73'')

UNION ALL

SELECT 
''CLIENT.CSV'' fileName
,''GENDER'' DataElement
,case when a.personal_id is null then ''STG_MD5_HASH_VALUE'' else ''PERSONAL_ID'' end ID_FIELD_1
,case when a.personal_id is null then a.stg_md5_hash_value else a.personal_id end ID_VALUE_1
,NULL ID_FIELD_2
,NULL ID_VALUE_2
,NULL ID_FIELD_3
,NULL ID_VALUE_3
,a.pstg_row_id
,a.source_file
,CASE WHEN GENDER_NONE = 99 THEN ''DATA NOT COLLECTED INDICATED FOR GENDER_NONE FIELD.'' 
WHEN GENDER_NONE IN (8,9) THEN ''CLIENT DOESN''''T KNOW OR PREFERS NOT TO ANSWER INDICATED FOR GENDER_NONE FIELD.'' END AS error_message
,CASE WHEN GENDER_NONE = 99 THEN ''GENDER_NONE = 99''
WHEN GENDER_NONE IN (8,9) THEN ''GENDER_NONE IN (8,9)'' END AS descr
,CASE WHEN GENDER_NONE = 99 THEN ''DATA NOT COLLECTED''
WHEN GENDER_NONE IN (8,9) THEN ''CLIENT DOESN''''T KNOW''
END AS ERROR_TYPE
,current_date() as date_loaded, '''' PRIORITIZATION
FROM hdis_dev.staging.pstg_client a
join enrollment en on a.personal_id = en.personal_id and a.source_file = en.source_file
WHERE ERROR_TYPE IS NOT NULL 

UNION ALL 

SELECT 
''CLIENT.CSV'' fileName
,''VETERAN STATUS'' DataElement
,case when a.personal_id is null then ''STG_MD5_HASH_VALUE'' else ''PERSONAL_ID'' end ID_FIELD_1
,case when a.personal_id is null then a.stg_md5_hash_value else a.personal_id end ID_VALUE_1
,NULL ID_FIELD_2
,NULL ID_VALUE_2
,NULL ID_FIELD_3
,NULL ID_VALUE_3
,a.pstg_row_id
,a.source_file
,error_message
,descr
,''INVALID RESPONSE'' ERROR_TYPE
,current_date() as date_loaded, PRIORITIZATION
FROM hdis_dev.staging.pstg_client a
join enrollment en on a.personal_id = en.personal_id and a.source_file = en.source_file
JOIN error_tbl b ON coalesce(a.personal_id, a.stg_md5_hash_value) = b.business_key_value and a.source_file = b.source_file and query_name IN (''CLIENT_109'', ''CLIENT_17'', ''CLIENT_45'', ''CLIENT_75'')

UNION ALL

SELECT 
''CLIENT.CSV'' fileName
,''VETERAN STATUS'' DataElement
,case when a.personal_id is null then ''STG_MD5_HASH_VALUE'' else ''PERSONAL_ID'' end ID_FIELD_1
,case when a.personal_id is null then a.stg_md5_hash_value else a.personal_id end ID_VALUE_1
,NULL ID_FIELD_2
,NULL ID_VALUE_2
,NULL ID_FIELD_3
,NULL ID_VALUE_3
,a.pstg_row_id
,a.source_file
,CASE WHEN VETERAN_STATUS = 99 THEN ''DATA NOT COLLECTED INDICATED FOR VETERAN_STATUS FIELD.''
WHEN VETERAN_STATUS IN (8,9) THEN ''CLIENT DOESN''''T KNOW INDICATED FOR VETERAN_STATUS FIELD.'' END AS error_message
,CASE WHEN VETERAN_STATUS = 99 THEN ''VETERAN_STATUS = 99''
WHEN VETERAN_STATUS IN (8,9) THEN ''VETERAN_STATUS IN (8,9)'' END AS descr
,CASE WHEN VETERAN_STATUS = 99 THEN ''DATA NOT COLLECTED''
WHEN VETERAN_STATUS IN (8,9) THEN ''CLIENT DOESN''''T KNOW'' END AS ERROR_TYPE
,current_date() as date_loaded, '''' PRIORITIZATION
FROM hdis_dev.staging.pstg_client a
join enrollment en on a.personal_id = en.personal_id and a.source_file = en.source_file
WHERE ERROR_TYPE IS NOT NULL

UNION ALL 

SELECT 
''CLIENT.CSV'' fileName
,''RACE/ETHNICITY'' DataElement
,case when a.personal_id is null then ''STG_MD5_HASH_VALUE'' else ''PERSONAL_ID'' end ID_FIELD_1
,case when a.personal_id is null then a.stg_md5_hash_value else a.personal_id end ID_VALUE_1
,NULL ID_FIELD_2
,NULL ID_VALUE_2
,NULL ID_FIELD_3
,NULL ID_VALUE_3
,a.pstg_row_id
,a.source_file
,error_message
,descr
,''INVALID RESPONSE'' ERROR_TYPE
,current_date() as date_loaded, PRIORITIZATION
FROM hdis_dev.staging.pstg_client a
join enrollment en on a.personal_id = en.personal_id and a.source_file = en.source_file
JOIN error_tbl b ON coalesce(a.personal_id, a.stg_md5_hash_value) = b.business_key_value and a.source_file = b.source_file and query_name IN (''CLIENT_5'', ''CLIENT_57'', ''CLIENT_47'', ''CLIENT_60'', ''CLIENT_48'', ''CLIENT_61'',''CLIENT_63'', ''CLIENT_9'', ''CLIENT_63'', ''CLIENT_59'', ''CLIENT_7'', ''CLIENT_10'', ''CLIENT_64'', ''CLIENT_6'', ''CLIENT_58'', ''CLIENT_8'', ''CLIENT_62'')

UNION ALL

SELECT 
''CLIENT.CSV'' fileName
,''RACE/ETHNICITY'' DataElement
,case when a.personal_id is null then ''STG_MD5_HASH_VALUE'' else ''PERSONAL_ID'' end ID_FIELD_1
,case when a.personal_id is null then a.stg_md5_hash_value else a.personal_id end ID_VALUE_1
,NULL ID_FIELD_2
,NULL ID_VALUE_2
,NULL ID_FIELD_3
,NULL ID_VALUE_3
,a.pstg_row_id
,a.source_file
,CASE WHEN RACE_NONE = 99 THEN ''DATA NOT COLLECTED INDICATED FOR RACE_NONE FIELD.'' 
WHEN RACE_NONE IN (8,9) THEN ''CLIENT DOESN''''T KNOW OR PREFERS NOT TO ANSWER INDICATED FOR RACE_NONE FIELD.'' END AS error_message
,CASE WHEN RACE_NONE = 99 THEN ''RACE_NONE = 99''
WHEN RACE_NONE IN (8,9) THEN ''RACE_NONE IN (8,9)'' END AS descr
,CASE WHEN RACE_NONE = 99 THEN ''DATA NOT COLLECTED''
WHEN RACE_NONE IN (8,9) THEN ''CLIENT DOESN''''T KNOW'' END AS ERROR_TYPE
,current_date() as date_loaded, '''' PRIORITIZATION
FROM hdis_dev.staging.pstg_client a
join enrollment en on a.personal_id = en.personal_id and a.source_file = en.source_file
WHERE ERROR_TYPE IS NOT NULL

UNION ALL

SELECT ''ORGANIZATION.CSV'' fileName
,''ALL'' DataElement
,case when a.organization_id is null then ''STG_MD5_HASH_VALUE'' else ''ORGANIZATION_ID'' end ID_FIELD_1
,case when a.organization_id is null then a.stg_md5_hash_value else a.organization_id end ID_VALUE_1
,NULL ID_FIELD_2
,NULL ID_VALUE_2
,NULL ID_FIELD_3
,NULL ID_VALUE_3
,a.pstg_row_id
,a.source_file
,c.error_message
,c.descr
,''INVALID RESPONSE'' ERROR_TYPE
,current_date() as date_loaded, PRIORITIZATION
FROM hdis_dev.staging.pstg_organization a
JOIN error_tbl c ON coalesce(a.organization_id,a.stg_md5_hash_value) = c.business_key_value and a.source_file = c.source_file and table_name like ''PSTG_ORGANIZATION'' and query_name NOT IN (''ORGANIZATION_1'', ''ORGANIZATION_2'', ''ORGANIZATION_3'', ''ORGANIZATION_4'', ''ORGANIZATION_12'', ''ORGANIZATION_13'', ''ORGANIZATION_14'', ''ORGANIZATION_16'', ''ORGANIZATION_17'', ''ORGANIZATION_18'', ''ORGANIZATION_20'') 

UNION ALL

SELECT ''PROJECTCOC.CSV'' fileName
,''ALL'' DataElement
,case when a.project_coc_id is null then ''STG_MD5_HASH_VALUE'' else ''PROJECT_COC_ID'' end ID_FIELD_1
,case when a.project_coc_id is null then a.stg_md5_hash_value else a.project_coc_id end ID_VALUE_1
,case when a.project_id is null then ''STG_MD5_HASH_VALUE'' else ''PROJECT_ID'' end ID_FIELD_2
,case when a.project_id is null then a.stg_md5_hash_value else a.project_id end ID_VALUE_2
,NULL ID_FIELD_3
,NULL ID_VALUE_3
,a.pstg_row_id
,a.source_file
,error_message
,descr
,''INVALID RESPONSE'' ERROR_TYPE
,current_date() as date_loaded, PRIORITIZATION
FROM hdis_dev.staging.pstg_project_coc a
JOIN error_tbl C ON coalesce(a.project_coc_id||''|''||a.project_id,a.stg_md5_hash_value) = c.business_key_value and a.source_file = c.source_file and table_name like ''PSTG_PROJECT_COC'' and query_name NOT IN (''PROJECT_COC_1'', ''PROJECT_COC_11'', ''PROJECT_COC_13'', ''PROJECT_COC_10'', ''PROJECT_COC_12'', ''PROJECT_COC_28'', ''PROJECT_COC_29'', ''PROJECT_COC_4'', ''PROJECT_COC_25'', ''PROJECT_COC_5'', ''PROJECT_COC_26'', ''PROJECT_COC_27'', ''PROJECT_COC_6'', ''PROJECT_COC_22'', ''PROJECT_COC_23'', ''PROJECT_COC_7'')

UNION ALL

SELECT ''PROJECTCOC.CSV'' fileName
,''ALL'' DataElement
,case when a.project_coc_id is null then ''STG_MD5_HASH_VALUE'' else ''PROJECT_COC_ID'' end ID_FIELD_1
,case when a.project_coc_id is null then a.stg_md5_hash_value else a.project_coc_id end ID_VALUE_1
,case when a.project_id is null then ''STG_MD5_HASH_VALUE'' else ''PROJECT_ID'' end ID_FIELD_2
,case when a.project_id is null then a.stg_md5_hash_value else a.project_id end ID_VALUE_2
,NULL ID_FIELD_3
,NULL ID_VALUE_3
,a.pstg_row_id
,a.source_file
,''DATA NOT COLLECTED INDICATED FOR GEOGRAPHY_TYPE FIELD.'' error_message
,''GEOGRAPHY_TYPE = 99'' descr
,CASE WHEN GEOGRAPHY_TYPE = 99 THEN ''DATA NOT COLLECTED'' END AS ERROR_TYPE
,current_date() as date_loaded, '''' PRIORITIZATION
FROM hdis_dev.staging.pstg_project_coc a
left join hdis_dev.staging.pstg_project b on a.project_id = b.project_id and a.source_file = b.source_file
WHERE ERROR_TYPE IS NOT NULL and coalesce(try_to_date(operating_end_date), CURRENT_TIMESTAMP) >= DATEADD(YEAR, - 1, DATE_TRUNC(''quarter'', DATEADD(''quarter'', - 4, CURRENT_DATE))) AND (YEAR(coalesce(try_to_date(operating_end_date), CURRENT_TIMESTAMP)) < YEAR(CURRENT_DATE) OR (YEAR(coalesce(try_to_date(operating_end_date), CURRENT_TIMESTAMP)) = YEAR(CURRENT_DATE) AND QUARTER(coalesce(try_to_date(operating_end_date), CURRENT_TIMESTAMP)) <= QUARTER(CURRENT_DATE)))

UNION ALL

SELECT ''FUNDER.CSV'' fileName
,''ALL'' DataElement
,case when a.funder_id is null then ''STG_MD5_HASH_VALUE'' else ''FUNDER_ID'' end ID_FIELD_1
,case when a.funder_id is null then a.stg_md5_hash_value else a.funder_id end ID_VALUE_1
,case when a.project_id is null then ''STG_MD5_HASH_VALUE'' else ''PROJECT_ID'' end ID_FIELD_2
,case when a.project_id is null then a.stg_md5_hash_value else a.project_id end ID_VALUE_2
,NULL ID_FIELD_3
,NULL ID_VALUE_3
,a.pstg_row_id
,a.source_file
,error_message
,descr
,''INVALID RESPONSE'' ERROR_TYPE
,current_date() as date_loaded, '''' PRIORITIZATION
FROM hdis_dev.staging.pstg_funder a
JOIN error_tbl b ON coalesce(a.funder_id||''|''||a.project_id,a.stg_md5_hash_value) = b.business_key_value and a.source_file = b.source_file and table_name like ''PSTG_FUNDER'' and query_name NOT IN (''FUNDER_42'', ''FUNDER_44'', ''FUNDER_57'', ''FUNDER_58'', ''FUNDER_43'', ''FUNDER_45'', ''FUNDER_1'', ''FUNDER_54'', ''FUNDER_6'', ''FUNDER_7'', ''FUNDER_55'', ''FUNDER_56'', ''FUNDER_8'', ''FUNDER_49'', ''FUNDER_9'', ''FUNDER_50'',''FUNDER_2'') 

UNION ALL

SELECT 
''ENROLLMENT.CSV'' fileName
,''DISABLING CONDITION'' DataElement
,case when a.enrollment_id is null then ''STG_MD5_HASH_VALUE'' else ''ENROLLMENT_ID'' end ID_FIELD_1
,case when a.enrollment_id is null then a.stg_md5_hash_value else a.enrollment_id end ID_VALUE_1
,case when a.personal_id is null then ''STG_MD5_HASH_VALUE'' else ''PERSONAL_ID'' end ID_FIELD_2
,case when a.personal_id is null then a.stg_md5_hash_value else a.personal_id end ID_VALUE_2
,NULL ID_FIELD_3
,NULL ID_VALUE_3
,a.pstg_row_id
,a.source_file
,error_message
,descr
,''INVALID RESPONSE'' ERROR_TYPE
,current_date() as date_loaded, PRIORITIZATION
FROM enrollment a
JOIN error_tbl b ON coalesce(a.enrollment_id,a.stg_md5_hash_value) = b.business_key_value and a.source_file = b.source_file and query_name in (''ENROLLMENT_6'', ''ENROLLMENT_34'', ''ENROLLMENT_86'')

UNION ALL

SELECT 
''ENROLLMENT.CSV'' fileName
,''DISABLING CONDITION'' DataElement
,case when a.enrollment_id is null then ''STG_MD5_HASH_VALUE'' else ''ENROLLMENT_ID'' end ID_FIELD_1
,case when a.enrollment_id is null then a.stg_md5_hash_value else a.enrollment_id end ID_VALUE_1
,case when a.personal_id is null then ''STG_MD5_HASH_VALUE'' else ''PERSONAL_ID'' end ID_FIELD_2
,case when a.personal_id is null then a.stg_md5_hash_value else a.personal_id end ID_VALUE_2
,NULL ID_FIELD_3
,NULL ID_VALUE_3
,a.pstg_row_id
,a.source_file
,CASE WHEN DISABLING_CONDITION = 99 THEN ''DATA NOT COLLECTED INDICATED FOR DISABLING_CONDITION FIELD.''
WHEN DISABLING_CONDITION IN (8,9) THEN ''CLIENT DOESN''''T KNOW OR PREFERS NOT TO ANSWER INDICATED FOR DISABLING_CONDITION FIELD.'' END AS error_message
,CASE WHEN DISABLING_CONDITION = 99 THEN ''DISABLING_CONDITION = 99'' 
WHEN DISABLING_CONDITION IN (8,9) THEN ''DISABLING_CONDITION IN (8,9)'' END AS descr
,CASE WHEN DISABLING_CONDITION = 99 THEN ''DATA NOT COLLECTED''
WHEN DISABLING_CONDITION IN (8,9) THEN ''CLIENT DOESN''''T KNOW'' END AS ERROR_TYPE
,current_date() as date_loaded, '''' PRIORITIZATION
FROM enrollment a
WHERE ERROR_TYPE IS NOT NULL 

UNION ALL

SELECT 
''ENROLLMENT.CSV'' fileName
,''RELATIONSHIP TO HOH'' DataElement
,case when a.enrollment_id is null then ''STG_MD5_HASH_VALUE'' else ''ENROLLMENT_ID'' end ID_FIELD_1
,case when a.enrollment_id is null then a.stg_md5_hash_value else a.enrollment_id end ID_VALUE_1
,case when a.personal_id is null then ''STG_MD5_HASH_VALUE'' else ''PERSONAL_ID'' end ID_FIELD_2
,case when a.personal_id is null then a.stg_md5_hash_value else a.personal_id end ID_VALUE_2
,NULL ID_FIELD_3
,NULL ID_VALUE_3
,a.pstg_row_id
,a.source_file
,error_message
,descr
,''INVALID RESPONSE'' ERROR_TYPE
,current_date() as date_loaded, PRIORITIZATION
FROM enrollment a
JOIN error_tbl b ON coalesce(a.enrollment_id,a.stg_md5_hash_value) = b.business_key_value and a.source_file = b.source_file and query_name in (''ENROLLMENT_27'', ''ENROLLMENT_79'', ''ENROLLMENT_163'', ''ENROLLMENT_164'', ''ENROLLMENT_5'')

UNION ALL

SELECT 
''ENROLLMENT.CSV'' fileName
,''RELATIONSHIP TO HOH'' DataElement
,case when a.enrollment_id is null then ''STG_MD5_HASH_VALUE'' else ''ENROLLMENT_ID'' end ID_FIELD_1
,case when a.enrollment_id is null then a.stg_md5_hash_value else a.enrollment_id end ID_VALUE_1
,case when a.personal_id is null then ''STG_MD5_HASH_VALUE'' else ''PERSONAL_ID'' end ID_FIELD_2
,case when a.personal_id is null then a.stg_md5_hash_value else a.personal_id end ID_VALUE_2
,NULL ID_FIELD_3
,NULL ID_VALUE_3
,a.pstg_row_id
,a.source_file
,CASE WHEN RELATIONSHIP_TO_HOH = 99 THEN ''DATA NOT COLLECTED INDICATED FOR RELATIONSHIP_TO_HOH FIELD.''
WHEN RELATIONSHIP_TO_HOH IN (8,9) THEN ''CLIENT DOESN''''T KNOW OR PREFERS NOT TO ANSWER INDICATED FOR RELATIONSHIP_TO_HOH FIELD.'' END AS error_message
,CASE WHEN RELATIONSHIP_TO_HOH = 99 THEN ''RELATIONSHIP_TO_HOH = 99''
WHEN RELATIONSHIP_TO_HOH IN (8,9) THEN ''RELATIONSHIP_TO_HOH IN (8,9)'' END AS descr
,CASE WHEN RELATIONSHIP_TO_HOH = 99 THEN ''DATA NOT COLLECTED''
WHEN RELATIONSHIP_TO_HOH IN (8,9) THEN ''CLIENT DOESN''''T KNOW'' END AS ERROR_TYPE
,current_date() as date_loaded, ''''  PRIORITIZATION
FROM enrollment a
WHERE ERROR_TYPE IS NOT NULL

UNION ALL

SELECT 
''ENROLLMENT.CSV'' fileName
,''LIVING SITUATION''  DataElement
,case when a.enrollment_id is null then ''STG_MD5_HASH_VALUE'' else ''ENROLLMENT_ID'' end ID_FIELD_1
,case when a.enrollment_id is null then a.stg_md5_hash_value else a.enrollment_id end ID_VALUE_1
,case when a.personal_id is null then ''STG_MD5_HASH_VALUE'' else ''PERSONAL_ID'' end ID_FIELD_2
,case when a.personal_id is null then a.stg_md5_hash_value else a.personal_id end ID_VALUE_2
,NULL ID_FIELD_3
,NULL ID_VALUE_3
,a.pstg_row_id
,a.source_file
,error_message
,descr
,''INVALID RESPONSE'' ERROR_TYPE
,current_date() as date_loaded, PRIORITIZATION
FROM enrollment a
JOIN error_tbl b ON coalesce(a.enrollment_id,a.stg_md5_hash_value) = b.business_key_value and a.source_file = b.source_file and query_name in (''ENROLLMENT_28'', ''ENROLLMENT_80'',''ENROLLMENT_29'', ''ENROLLMENT_81'',''ENROLLMENT_17'',''ENROLLMENT_32'', ''ENROLLMENT_84'',''ENROLLMENT_33'',''ENROLLMENT_85'',''ENROLLMENT_18'')

UNION ALL

SELECT 
''ENROLLMENT.CSV'' fileName
,''LIVING SITUATION''  DataElement
,case when a.enrollment_id is null then ''STG_MD5_HASH_VALUE'' else ''ENROLLMENT_ID'' end ID_FIELD_1
,case when a.enrollment_id is null then a.stg_md5_hash_value else a.enrollment_id end ID_VALUE_1
,case when a.personal_id is null then ''STG_MD5_HASH_VALUE'' else ''PERSONAL_ID'' end ID_FIELD_2
,case when a.personal_id is null then a.stg_md5_hash_value else a.personal_id end ID_VALUE_2
,NULL ID_FIELD_3
,NULL ID_VALUE_3
,a.pstg_row_id
,a.source_file
,CASE WHEN LIVING_SITUATION = 99 THEN ''DATA NOT COLLECTED INDICATED FOR LIVING_SITUATION FIELD.''
WHEN LIVING_SITUATION IN (8,9) THEN ''CLIENT DOESN''''T KNOW OR PREFERS NOT TO ANSWER INDICATED FOR LIVING_SITUATION FIELD.'' END AS error_message
,CASE WHEN LIVING_SITUATION = 99 THEN ''LIVING_SITUATION = 99'' 
WHEN LIVING_SITUATION IN (8,9) THEN ''LIVING SITUATION IN (8,9)'' END AS descr
,CASE WHEN LIVING_SITUATION = 99 THEN ''DATA NOT COLLECTED''
WHEN LIVING_SITUATION IN (8,9) THEN ''CLIENT DOESN''''T KNOW'' END AS ERROR_TYPE
,current_date() as date_loaded, '''' PRIORITIZATION
FROM enrollment a
WHERE ERROR_TYPE IS NOT NULL 

UNION ALL

SELECT 
''ENROLLMENT.CSV'' fileName
,''ENTRY DATE'' DataElement
,case when a.enrollment_id is null then ''STG_MD5_HASH_VALUE'' else ''ENROLLMENT_ID'' end ID_FIELD_1
,case when a.enrollment_id is null then a.stg_md5_hash_value else a.enrollment_id end ID_VALUE_1
,case when a.personal_id is null then ''STG_MD5_HASH_VALUE'' else ''PERSONAL_ID'' end ID_FIELD_2
,case when a.personal_id is null then a.stg_md5_hash_value else a.personal_id end ID_VALUE_2
,NULL ID_FIELD_3
,NULL ID_VALUE_3
,a.pstg_row_id
,a.source_file
,error_message
,descr
,''INVALID RESPONSE'' ERROR_TYPE
,current_date() as date_loaded, PRIORITIZATION
FROM enrollment a
JOIN error_tbl b ON coalesce(a.enrollment_id,a.stg_md5_hash_value) = b.business_key_value and a.source_file = b.source_file and query_name in (''ENROLLMENT_3'', ''ENROLLMENT_124'', ''ENROLLMENT_142'', ''ENROLLMENT_143'', ''ENROLLMENT_146'', ''ENROLLMENT_147'', ''ENROLLMENT_153'')

UNION ALL

SELECT 
''ENROLLMENT.CSV'' fileName
,''MOVE IN DATE'' DataElement
,case when a.enrollment_id is null then ''STG_MD5_HASH_VALUE'' else ''ENROLLMENT_ID'' end ID_FIELD_1
,case when a.enrollment_id is null then a.stg_md5_hash_value else a.enrollment_id end ID_VALUE_1
,case when a.personal_id is null then ''STG_MD5_HASH_VALUE'' else ''PERSONAL_ID'' end ID_FIELD_2
,case when a.personal_id is null then a.stg_md5_hash_value else a.personal_id end ID_VALUE_2
,NULL ID_FIELD_3
,NULL ID_VALUE_3
,a.pstg_row_id
,a.source_file
,error_message
,descr
,''INVALID RESPONSE'' ERROR_TYPE
,current_date() as date_loaded, PRIORITIZATION
FROM enrollment a
JOIN error_tbl b ON coalesce(a.enrollment_id,a.stg_md5_hash_value) = b.business_key_value and a.source_file = b.source_file and query_name in (''ENROLLMENT_20'', ''ENROLLMENT_127'', ''ENROLLMENT_19'')

UNION ALL

SELECT 
''ENROLLMENT.CSV'' fileName
,''DATE OF ENGAGEMENT'' DataElement
,case when a.enrollment_id is null then ''STG_MD5_HASH_VALUE'' else ''ENROLLMENT_ID'' end ID_FIELD_1
,case when a.enrollment_id is null then a.stg_md5_hash_value else a.enrollment_id end ID_VALUE_1
,case when a.personal_id is null then ''STG_MD5_HASH_VALUE'' else ''PERSONAL_ID'' end ID_FIELD_2
,case when a.personal_id is null then a.stg_md5_hash_value else a.personal_id end ID_VALUE_2
,NULL ID_FIELD_3
,NULL ID_VALUE_3
,a.pstg_row_id
,a.source_file
,error_message
,descr
,''INVALID RESPONSE'' ERROR_TYPE
,current_date() as date_loaded, PRIORITIZATION
FROM enrollment a
JOIN error_tbl b ON coalesce(a.enrollment_id,a.stg_md5_hash_value) = b.business_key_value and a.source_file = b.source_file and query_name = ''ENROLLMENT_126''


UNION ALL

SELECT ''INCOMEBENEFITS.CSV'' fileName
,''INCOME AND BENEFITS'' DataElement
,case when a.income_benefits_id is null then ''STG_MD5_HASH_VALUE'' else ''INCOME_BENEFITS_ID'' end ID_FIELD_1
,case when a.income_benefits_id is null then a.stg_md5_hash_value else a.income_benefits_id end ID_VALUE_1
,case when a.enrollment_id is null then ''STG_MD5_HASH_VALUE'' else ''ENROLLMENT_ID'' end ID_FIELD_1
,case when a.enrollment_id is null then a.stg_md5_hash_value else a.enrollment_id end ID_VALUE_1
,case when a.personal_id is null then ''STG_MD5_HASH_VALUE'' else ''PERSONAL_ID'' end ID_FIELD_3
,case when a.personal_id is null then a.stg_md5_hash_value else a.personal_id end ID_VALUE_3
,a.pstg_row_id
,a.source_file
,error_message
,descr
,''INVALID RESPONSE'' ERROR_TYPE
,current_date() as date_loaded, PRIORITIZATION
FROM hdis_dev.staging.pstg_income_benefits a
join enrollment en on a.enrollment_id = en.enrollment_id and a.source_file = en.source_file
JOIN error_tbl b ON coalesce(a.income_benefits_id||''|''||a.enrollment_id||''|''||a.personal_id||''|''||a.information_date,a.stg_md5_hash_value) = b.business_key_value and a.source_file = b.source_file and query_name in (''INCOME_BENEFITS_5'', ''INCOME_BENEFITS_57'', ''INCOME_BENEFITS_149'', ''INCOME_BENEFITS_6'', ''INCOME_BENEFITS_58'', ''INCOME_BENEFITS_7'', ''INCOME_BENEFITS_59'', ''INCOME_BENEFITS_60'', ''INCOME_BENEFITS_8'', ''INCOME_BENEFITS_61'', ''INCOME_BENEFITS_9'', ''INCOME_BENEFITS_10'', ''INCOME_BENEFITS_62'', ''INCOME_BENEFITS_11'', ''INCOME_BENEFITS_63'', ''INCOME_BENEFITS_12'', ''INCOME_BENEFITS_64'', ''INCOME_BENEFITS_13'', ''INCOME_BENEFITS_65'', ''INCOME_BENEFITS_14'', ''INCOME_BENEFITS_66'', ''INCOME_BENEFITS_15'', ''INCOME_BENEFITS_67'', ''INCOME_BENEFITS_16'', ''INCOME_BENEFITS_68'', ''INCOME_BENEFITS_17'', ''INCOME_BENEFITS_69'', ''INCOME_BENEFITS_70'', ''INCOME_BENEFITS_18'', ''INCOME_BENEFITS_19'', ''INCOME_BENEFITS_71'', ''INCOME_BENEFITS_72'', ''INCOME_BENEFITS_20'')

UNION ALL

SELECT ''INCOMEBENEFITS.CSV'' fileName
,''INCOME AND BENEFITS'' DataElement
,case when a.income_benefits_id is null then ''STG_MD5_HASH_VALUE'' else ''INCOME_BENEFITS_ID'' end ID_FIELD_1
,case when a.income_benefits_id is null then a.stg_md5_hash_value else a.income_benefits_id end ID_VALUE_1
,case when a.enrollment_id is null then ''STG_MD5_HASH_VALUE'' else ''ENROLLMENT_ID'' end ID_FIELD_1
,case when a.enrollment_id is null then a.stg_md5_hash_value else a.enrollment_id end ID_VALUE_1
,case when a.personal_id is null then ''STG_MD5_HASH_VALUE'' else ''PERSONAL_ID'' end ID_FIELD_3
,case when a.personal_id is null then a.stg_md5_hash_value else a.personal_id end ID_VALUE_3
,a.pstg_row_id
,a.source_file
,CASE WHEN INCOME_FROM_ANY_SOURCE = 99 THEN ''DATA NOT COLLECTED INDICATED FOR INCOME_FROM_ANY_SOURCE FIELD.''
WHEN INCOME_FROM_ANY_SOURCE IN (8,9) THEN ''CLIENT DOESN''''T KNOW OR PREFERS NOT TO ANSWER INDICATED FOR INCOME_FROM_ANY_SOURCE FIELD.'' END AS error_message
,CASE WHEN INCOME_FROM_ANY_SOURCE = 99 THEN ''INCOME_FROM_ANY_SOURCE = 99''
WHEN INCOME_FROM_ANY_SOURCE IN (8,9) THEN ''INCOME_FROM_ANY_SOURCE IN (8,9)'' END AS descr
,CASE WHEN INCOME_FROM_ANY_SOURCE = 99 THEN ''DATA NOT COLLECTED''
WHEN INCOME_FROM_ANY_SOURCE IN (8,9) THEN ''CLIENT DOESN''''T KNOW'' END AS ERROR_TYPE
,current_date() as date_loaded, '''' PRIORITIZATION
FROM hdis_dev.staging.pstg_income_benefits a 
JOIN enrollment b on a.enrollment_id = b.enrollment_id and a.source_File = b.source_file
WHERE ERROR_TYPE IS NOT NULL 

UNION ALL

SELECT ''INCOMEBENEFITS.CSV'' fileName
,''HEALTH INSURANCE'' DataElement
,case when a.income_benefits_id is null then ''STG_MD5_HASH_VALUE'' else ''INCOME_BENEFITS_ID'' end ID_FIELD_1
,case when a.income_benefits_id is null then a.stg_md5_hash_value else a.income_benefits_id end ID_VALUE_1
,case when a.enrollment_id is null then ''STG_MD5_HASH_VALUE'' else ''ENROLLMENT_ID'' end ID_FIELD_1
,case when a.enrollment_id is null then a.stg_md5_hash_value else a.enrollment_id end ID_VALUE_1
,case when a.personal_id is null then ''STG_MD5_HASH_VALUE'' else ''PERSONAL_ID'' end ID_FIELD_3
,case when a.personal_id is null then a.stg_md5_hash_value else a.personal_id end ID_VALUE_3
,a.pstg_row_id
,a.source_file
,error_message
,descr
,''INVALID RESPONSE'' ERROR_TYPE
,current_date() as date_loaded, PRIORITIZATION
FROM hdis_dev.staging.pstg_income_benefits a 
join enrollment en on a.enrollment_id = en.enrollment_id and a.source_file = en.source_file
JOIN error_tbl b ON coalesce(a.income_benefits_id||''|''||a.enrollment_id||''|''||a.personal_id||''|''||a.information_date,a.stg_md5_hash_value) = b.business_key_value and a.source_file = b.source_file and query_name in (''INCOME_BENEFITS_30'', ''INCOME_BENEFITS_80'', ''INCOME_BENEFITS_31'', ''INCOME_BENEFITS_81'', ''INCOME_BENEFITS_32'', ''INCOME_BENEFITS_82'', ''INCOME_BENEFITS_132'', ''INCOME_BENEFITS_83'', ''INCOME_BENEFITS_84'', ''INCOME_BENEFITS_133'', ''INCOME_BENEFITS_85'', ''INCOME_BENEFITS_33'', ''INCOME_BENEFITS_86'', ''INCOME_BENEFITS_134'', ''INCOME_BENEFITS_34'', ''INCOME_BENEFITS_87'', ''INCOME_BENEFITS_35'', ''INCOME_BENEFITS_88'', ''INCOME_BENEFITS_135'', ''INCOME_BENEFITS_36'', ''INCOME_BENEFITS_37'', ''INCOME_BENEFITS_89'', ''INCOME_BENEFITS_38'', ''INCOME_BENEFITS_90'', ''INCOME_BENEFITS_136'', ''INCOME_BENEFITS_43'', ''INCOME_BENEFITS_95'', ''INCOME_BENEFITS_44'', ''INCOME_BENEFITS_96'', ''INCOME_BENEFITS_139'', ''INCOME_BENEFITS_45'', ''INCOME_BENEFITS_97'', ''INCOME_BENEFITS_46'', ''INCOME_BENEFITS_98'', ''INCOME_BENEFITS_140'', ''INCOME_BENEFITS_47'', ''INCOME_BENEFITS_48'', ''INCOME_BENEFITS_99'', ''INCOME_BENEFITS_141'', ''INCOME_BENEFITS_49'', ''INCOME_BENEFITS_100'', ''INCOME_BENEFITS_50'', ''INCOME_BENEFITS_101'', ''INCOME_BENEFITS_102'', ''INCOME_BENEFITS_143'', ''INCOME_BENEFITS_103'', ''INCOME_BENEFITS_52'', ''INCOME_BENEFITS_104'', ''INCOME_BENEFITS_53'')

UNION ALL

SELECT ''INCOMEBENEFITS.CSV'' fileName
,''HEALTH INSURANCE'' DataElement
,case when a.income_benefits_id is null then ''STG_MD5_HASH_VALUE'' else ''INCOME_BENEFITS_ID'' end ID_FIELD_1
,case when a.income_benefits_id is null then a.stg_md5_hash_value else a.income_benefits_id end ID_VALUE_1
,case when a.enrollment_id is null then ''STG_MD5_HASH_VALUE'' else ''ENROLLMENT_ID'' end ID_FIELD_1
,case when a.enrollment_id is null then a.stg_md5_hash_value else a.enrollment_id end ID_VALUE_1
,case when a.personal_id is null then ''STG_MD5_HASH_VALUE'' else ''PERSONAL_ID'' end ID_FIELD_3
,case when a.personal_id is null then a.stg_md5_hash_value else a.personal_id end ID_VALUE_3
,a.pstg_row_id
,a.source_file
,CASE WHEN INSURANCE_FROM_ANY_SOURCE = 99 THEN ''DATA NOT COLLECTED INDICATED FOR INSURANCE_FROM_ANY_SOURCE FIELD.''
WHEN INSURANCE_FROM_ANY_SOURCE IN (8,9) THEN ''CLIENT DOESN''''T KNOW OR PREFERS NOT TO ANSWER INDICATED FOR INSURANCE_FROM_ANY_SOURCE FIELD.'' END AS error_message
,CASE WHEN INSURANCE_FROM_ANY_SOURCE = 99 THEN ''INSURANCE_FROM_ANY_SOURCE = 99''
WHEN INSURANCE_FROM_ANY_SOURCE IN (8,9) THEN ''INSURANCE_FROM_ANY_SOURCE IN (8,9)'' END AS DESCR
,CASE WHEN INSURANCE_FROM_ANY_SOURCE = 99 THEN ''DATA NOT COLLECTED''
WHEN INSURANCE_FROM_ANY_SOURCE IN (8,9) THEN ''CLIENT DOESN''''T KNOW'' END AS ERROR_TYPE
,current_date() as date_loaded, '''' PRIORITIZATION
FROM hdis_dev.staging.pstg_income_benefits a 
JOIN enrollment b on a.enrollment_id = b.enrollment_id and a.source_file = b.source_file
WHERE ERROR_TYPE IS NOT NULL 

UNION ALL

SELECT ''INCOMEBENEFITS.CSV'' fileName
,''NON CASH BENEFITS'' DataElement
,case when a.income_benefits_id is null then ''STG_MD5_HASH_VALUE'' else ''INCOME_BENEFITS_ID'' end ID_FIELD_1
,case when a.income_benefits_id is null then a.stg_md5_hash_value else a.income_benefits_id end ID_VALUE_1
,case when a.enrollment_id is null then ''STG_MD5_HASH_VALUE'' else ''ENROLLMENT_ID'' end ID_FIELD_1
,case when a.enrollment_id is null then a.stg_md5_hash_value else a.enrollment_id end ID_VALUE_1
,case when a.personal_id is null then ''STG_MD5_HASH_VALUE'' else ''PERSONAL_ID'' end ID_FIELD_3
,case when a.personal_id is null then a.stg_md5_hash_value else a.personal_id end ID_VALUE_3
,a.pstg_row_id
,a.source_file
,error_message
,descr
,''INVALID RESPONSE'' ERROR_TYPE
,current_date() as date_loaded, PRIORITIZATION
FROM hdis_dev.staging.pstg_income_benefits a 
join enrollment en on a.enrollment_id = en.enrollment_id and a.source_file = en.source_file
JOIN error_tbl b ON coalesce(a.income_benefits_id||''|''||a.enrollment_id||''|''||a.personal_id||''|''||a.information_date,a.stg_md5_hash_value) = b.business_key_value and a.source_file = b.source_file and query_name in (''INCOME_BENEFITS_22'', ''INCOME_BENEFITS_73'', ''INCOME_BENEFITS_23'', ''INCOME_BENEFITS_74'', ''INCOME_BENEFITS_24'', ''INCOME_BENEFITS_75'', ''INCOME_BENEFITS_25'', ''INCOME_BENEFITS_76'', ''INCOME_BENEFITS_26'', ''INCOME_BENEFITS_77'', ''INCOME_BENEFITS_27'', ''INCOME_BENEFITS_78'', ''INCOME_BENEFITS_28'', ''INCOME_BENEFITS_79'')

UNION ALL

SELECT ''INCOMEBENEFITS.CSV'' fileName
,''NON CASH BENEFITS'' DataElement
,case when a.income_benefits_id is null then ''STG_MD5_HASH_VALUE'' else ''INCOME_BENEFITS_ID'' end ID_FIELD_1
,case when a.income_benefits_id is null then a.stg_md5_hash_value else a.income_benefits_id end ID_VALUE_1
,case when a.enrollment_id is null then ''STG_MD5_HASH_VALUE'' else ''ENROLLMENT_ID'' end ID_FIELD_1
,case when a.enrollment_id is null then a.stg_md5_hash_value else a.enrollment_id end ID_VALUE_1
,case when a.personal_id is null then ''STG_MD5_HASH_VALUE'' else ''PERSONAL_ID'' end ID_FIELD_3
,case when a.personal_id is null then a.stg_md5_hash_value else a.personal_id end ID_VALUE_3
,a.pstg_row_id
,a.source_file
,CASE WHEN BENEFITS_FROM_ANY_SOURCE = 99 THEN ''DATA NOT COLLECTED INDICATED FOR BENEFITS_FROM_ANY_SOURCE FIELD.''
WHEN BENEFITS_FROM_ANY_SOURCE IN (8,9) THEN ''CLIENT DOESN''''T KNOW OR PREFERS NOT TO ANSWER INDICATED FOR BENEFITS_FROM_ANY_SOURCE FIELD.'' END AS error_message
,CASE WHEN BENEFITS_FROM_ANY_SOURCE = 99 THEN ''BENEFITS_FROM_ANY_SOURCE = 99''
WHEN BENEFITS_FROM_ANY_SOURCE IN (8,9) THEN ''BENEFITS_FROM_ANY_SOURCE IN (8,9)'' END AS descr
,CASE WHEN BENEFITS_FROM_ANY_SOURCE = 99 THEN ''DATA NOT COLLECTED''
WHEN BENEFITS_FROM_ANY_SOURCE IN (8,9) THEN ''CLIENT DOESN''''T KNOW'' END AS ERROR_TYPE
,current_date() as date_loaded, '''' PRIORITIZATION
FROM hdis_dev.staging.pstg_income_benefits a 
JOIN enrollment b on a.enrollment_id = b.enrollment_id and a.source_file = b.source_file
WHERE ERROR_TYPE IS NOT NULL 

UNION ALL

SELECT 
''HEALTHANDDV.CSV'' fileName
,''DOMESTIC VIOLENCE'' DataElement
,case when a.health_and_dv_id is null then ''STG_MD5_HASH_VALUE'' else ''HEALTH_AND_DV_ID'' end ID_FIELD_1
,case when a.health_and_dv_id is null then a.stg_md5_hash_value else a.health_and_dv_id end ID_VALUE_1
,case when a.enrollment_id is null then ''STG_MD5_HASH_VALUE'' else ''ENROLLMENT_ID'' end ID_FIELD_2
,case when a.enrollment_id is null then a.stg_md5_hash_value else a.enrollment_id end ID_VALUE_2
,case when a.personal_id is null then ''STG_MD5_HASH_VALUE'' else ''PERSONAL_ID'' end ID_FIELD_3
,case when a.personal_id is null then a.stg_md5_hash_value else a.personal_id end ID_VALUE_3
,a.pstg_row_id
,a.source_file
,error_message
,descr
,''INVALID RESPONSE'' ERROR_TYPE
,current_date() as date_loaded, PRIORITIZATION
FROM hdis_dev.staging.pstg_health_and_dv a
join enrollment en on a.enrollment_id = en.enrollment_id and a.source_file = en.source_file
JOIN error_tbl b ON coalesce(a.health_and_dv_id||''|''||a.enrollment_id||''|''||a.personal_id||''|''||a.information_date, a.stg_md5_hash_value) = b.business_key_value and a.source_file = b.source_file and b.query_name IN (''HEALTH_AND_DV_5'', ''HEALTH_AND_DV_15'')

UNION ALL

SELECT 
''HEALTHANDDV.CSV'' fileName
,''DOMESTIC VIOLENCE'' DataElement
,case when a.health_and_dv_id is null then ''STG_MD5_HASH_VALUE'' else ''HEALTH_AND_DV_ID'' end ID_FIELD_1
,case when a.health_and_dv_id is null then a.stg_md5_hash_value else a.health_and_dv_id end ID_VALUE_1
,case when a.enrollment_id is null then ''STG_MD5_HASH_VALUE'' else ''ENROLLMENT_ID'' end ID_FIELD_2
,case when a.enrollment_id is null then a.stg_md5_hash_value else a.enrollment_id end ID_VALUE_2
,case when a.personal_id is null then ''STG_MD5_HASH_VALUE'' else ''PERSONAL_ID'' end ID_FIELD_3
,case when a.personal_id is null then a.stg_md5_hash_value else a.personal_id end ID_VALUE_3
,a.pstg_row_id
,a.source_file
,CASE WHEN DOMESTIC_VIOLENCE_SURVIVOR = 99 THEN ''DATA NOT COLLECTED INDICATED FOR DOMESTIC_VIOLENCE_SURVIVOR FIELD.''
WHEN DOMESTIC_VIOLENCE_SURVIVOR IN (8,9) THEN ''CLIENT DOESN''''T KNOW OR PREFERS NOT TO ANSWER INDICATED FOR DOMESTIC_VIOLENCE_SURVIVOR FIELD.'' END AS error_message
,CASE WHEN DOMESTIC_VIOLENCE_SURVIVOR = 99 THEN ''DOMESTIC_VIOLENCE_SURVIVOR = 99'' 
WHEN DOMESTIC_VIOLENCE_SURVIVOR IN (8,9) THEN ''DOMESTIC_VIOLENCE_SURVIVOR IN (8,9)'' END AS descr
,CASE WHEN DOMESTIC_VIOLENCE_SURVIVOR = 99 THEN ''DATA NOT COLLECTED''
WHEN DOMESTIC_VIOLENCE_SURVIVOR IN (8,9) THEN ''CLIENT DOESN''''T KNOW'' END AS ERROR_TYPE
,current_date() as date_loaded, '''' PRIORITIZATION
FROM hdis_dev.staging.pstg_health_and_dv a
JOIN enrollment b on a.enrollment_id = b.enrollment_id and a.source_file = b.source_file
WHERE ERROR_TYPE IS NOT NULL 

UNION ALL

SELECT 
''SERVICES.CSV'' fileName
,''BED NIGHTS'' DataElement
,case when a.services_id is null then ''STG_MD5_HASH_VALUE'' else ''SERVICES_ID'' end ID_FIELD_1
,case when a.services_id is null then a.stg_md5_hash_value else a.services_id end ID_VALUE_1
,case when a.enrollment_id is null then ''STG_MD5_HASH_VALUE'' else ''ENROLLMENT_ID'' end ID_FIELD_2
,case when a.enrollment_id is null then a.stg_md5_hash_value else a.enrollment_id end ID_VALUE_2
,case when a.personal_id is null then ''STG_MD5_HASH_VALUE'' else ''PERSONAL_ID'' end ID_FIELD_3
,case when a.personal_id is null then a.stg_md5_hash_value else a.personal_id end ID_VALUE_3
,a.pstg_row_id
,a.source_file
,error_message
,descr
,''INVALID RESPONSE'' ERROR_TYPE
,current_date() as date_loaded, PRIORITIZATION
FROM hdis_dev.staging.pstg_services a
join enrollment en on a.enrollment_id = en.enrollment_id and a.source_file = en.source_file
JOIN error_tbl b ON coalesce(a.services_id||''|''||a.enrollment_id||''|''||a.personal_id||''|''||a.date_provided||''|''||a.record_type||''|''||a.type_provided,a.stg_md5_hash_value)= b.business_key_value and a.source_file = b.source_file and b.query_name = ''SERVICES_51''

UNION ALL

SELECT ''EXIT.CSV'' fileName
,''EXIT DATE'' DataElement
,case when a.exit_id is null then ''STG_MD5_HASH_VALUE'' else ''EXIT_ID'' end ID_FIELD_1
,case when a.exit_id is null then a.stg_md5_hash_value else a.exit_id end ID_VALUE_1
,case when a.enrollment_id is null then ''STG_MD5_HASH_VALUE'' else ''ENROLLMENT_ID'' end ID_FIELD_2
,case when a.enrollment_id is null then a.stg_md5_hash_value else a.enrollment_id end ID_VALUE_2
,case when a.personal_id is null then ''STG_MD5_HASH_VALUE'' else ''PERSONAL_ID'' end ID_FIELD_3
,case when a.personal_id is null then a.stg_md5_hash_value else a.personal_id end ID_VALUE_3
,a.pstg_row_id
,a.source_file
,error_message	
,descr
,''INVALID RESPONSE'' ERROR_TYPE
,current_date() as date_loaded, PRIORITIZATION
FROM hdis_dev.staging.pstg_exit a
join enrollment en on a.enrollment_id = en.enrollment_id and a.source_file = en.source_file
JOIN error_tbl b ON coalesce(a.exit_id||''|''||a.enrollment_id, a.stg_md5_hash_value) = b.business_key_value and a.source_file = b.source_file and query_name = ''EXIT_102''

UNION ALL

SELECT ''EXIT.CSV'' fileName
,''DESTINATION'' DataElement
,case when a.exit_id is null then ''STG_MD5_HASH_VALUE'' else ''EXIT_ID'' end ID_FIELD_1
,case when a.exit_id is null then a.stg_md5_hash_value else a.exit_id end ID_VALUE_1
,case when a.enrollment_id is null then ''STG_MD5_HASH_VALUE'' else ''ENROLLMENT_ID'' end ID_FIELD_2
,case when a.enrollment_id is null then a.stg_md5_hash_value else a.enrollment_id end ID_VALUE_2
,case when a.personal_id is null then ''STG_MD5_HASH_VALUE'' else ''PERSONAL_ID'' end ID_FIELD_3
,case when a.personal_id is null then a.stg_md5_hash_value else a.personal_id end ID_VALUE_3
,a.pstg_row_id
,a.source_file
,error_message	
,descr
,''INVALID RESPONSE'' ERROR_TYPE
,current_date() as date_loaded, PRIORITIZATION
FROM hdis_dev.staging.pstg_exit a
join enrollment en on a.enrollment_id = en.enrollment_id and a.source_file = en.source_file
JOIN error_tbl b ON coalesce(a.exit_id||''|''||a.enrollment_id, a.stg_md5_hash_value) = b.business_key_value and a.source_file = b.source_file and query_name IN (''EXIT_4'', ''EXIT_30'', ''EXIT_35'', ''EXIT_71'')

UNION ALL

SELECT ''EXIT.CSV'' fileName
,''DESTINATION'' DataElement
,case when a.exit_id is null then ''STG_MD5_HASH_VALUE'' else ''EXIT_ID'' end ID_FIELD_1
,case when a.exit_id is null then a.stg_md5_hash_value else a.exit_id end ID_VALUE_1
,case when a.enrollment_id is null then ''STG_MD5_HASH_VALUE'' else ''ENROLLMENT_ID'' end ID_FIELD_2
,case when a.enrollment_id is null then a.stg_md5_hash_value else a.enrollment_id end ID_VALUE_2
,case when a.personal_id is null then ''STG_MD5_HASH_VALUE'' else ''PERSONAL_ID'' end ID_FIELD_3
,case when a.personal_id is null then a.stg_md5_hash_value else a.personal_id end ID_VALUE_3
,a.pstg_row_id
,a.source_file
,CASE WHEN DESTINATION in (17,30,99) THEN ''DATA NOT COLLECTED INDICATED FOR DESTINATION FIELD.''
WHEN DESTINATION IN (8,9) THEN ''CLIENT DOESN''''T KNOW OR PREFERS NOT TO ANSWER INDICATED FOR DESTINATION FIELD.'' END AS error_message	
,CASE WHEN DESTINATION in (17,30,99) THEN ''DESTINATION in (17,30,99)'' 
WHEN DESTINATION IN (8,9) THEN ''DESTINATION IN (8,9)'' END AS descr
,CASE WHEN DESTINATION in (17,30,99) THEN ''DATA NOT COLLECTED''
WHEN DESTINATION IN (8,9) THEN ''CLIENT DOESN''''T KNOW'' END AS ERROR_TYPE
,current_date() as date_loaded, ''''  PRIORITIZATION
FROM hdis_dev.staging.pstg_exit a
JOIN enrollment b on a.enrollment_id = b.enrollment_id and a.source_file = b.source_file
WHERE ERROR_TYPE IS NOT NULL  

UNION ALL

SELECT ''CURRENTLIVINGSITUATION.CSV'' fileName
,''CURRENT LIVING SITUATION'' ColumnName
,case when a.current_living_sit_id is null then ''STG_MD5_HASH_VALUE'' else ''CURRENT_LIVING_SIT_ID'' end ID_FIELD_1
,case when a.current_living_sit_id is null then a.stg_md5_hash_value else a.current_living_sit_id end ID_VALUE_1
,case when a.enrollment_id is null then ''STG_MD5_HASH_VALUE'' else ''ENROLLMENT_ID'' end ID_FIELD_2
,case when a.enrollment_id is null then a.stg_md5_hash_value else a.enrollment_id end ID_VALUE_2
,case when a.personal_id is null then ''STG_MD5_HASH_VALUE'' else ''PERSONAL_ID'' end ID_FIELD_3
,case when a.personal_id is null then a.stg_md5_hash_value else a.personal_id end ID_VALUE_3
,a.pstg_row_id
,a.source_file
,error_message
,descr
,''INVALID RESPONSE'' ERROR_TYPE
,current_date() as date_loaded, PRIORITIZATION
FROM hdis_dev.staging.pstg_current_living_situation a
JOIN enrollment c on a.enrollment_id = c.enrollment_id and a.source_file = c.source_file
JOIN error_tbl b ON coalesce(a.current_living_sit_id||''|''||a.enrollment_id||''|''||a.personal_id||''|''||a.information_date||''|''||a.current_living_situation, a.stg_md5_hash_value) = b.business_key_value and a.source_file = b.source_file and query_name in (''CURRENT_LIVING_SITUATION_4'', ''CURRENT_LIVING_SITUATION_21'', ''CURRENT_LIVING_SITUATION_32'') 

UNION ALL

SELECT ''CURRENTLIVINGSITUATION.CSV'' fileName
,''CURRENT LIVING SITUATION'' ColumnName
,case when a.current_living_sit_id is null then ''STG_MD5_HASH_VALUE'' else ''CURRENT_LIVING_SIT_ID'' end ID_FIELD_1
,case when a.current_living_sit_id is null then a.stg_md5_hash_value else a.current_living_sit_id end ID_VALUE_1
,case when a.enrollment_id is null then ''STG_MD5_HASH_VALUE'' else ''ENROLLMENT_ID'' end ID_FIELD_2
,case when a.enrollment_id is null then a.stg_md5_hash_value else a.enrollment_id end ID_VALUE_2
,case when a.personal_id is null then ''STG_MD5_HASH_VALUE'' else ''PERSONAL_ID'' end ID_FIELD_3
,case when a.personal_id is null then a.stg_md5_hash_value else a.personal_id end ID_VALUE_3
,a.pstg_row_id
,a.source_file
,CASE WHEN CURRENT_LIVING_SITUATION = 99 THEN ''DATA NOT COLLECTED INDICATED FOR CURRENT_LIVING_SITUATION FIELD.''
WHEN CURRENT_LIVING_SITUATION IN (8,9) THEN ''CLIENT DOESN''''T KNOW INDICATED FOR CURRENT_LIVING_SITUATION FIELD.'' END AS error_message
,CASE WHEN CURRENT_LIVING_SITUATION = 99 THEN ''CURRENT_LIVING_SITUATION = 99''
WHEN CURRENT_LIVING_SITUATION IN (8,9) THEN ''CURRENT_LIVING_SITUATION IN (8,9)'' END AS descr
,CASE WHEN CURRENT_LIVING_SITUATION = 99 THEN ''DATA NOT COLLECTED''
WHEN CURRENT_LIVING_SITUATION IN (8,9) THEN ''CLIENT DOESN''''T KNOW'' END AS ERROR_TYPE
,current_date() as date_loaded, ''''  PRIORITIZATION
FROM hdis_dev.staging.pstg_current_living_situation a
JOIN enrollment b on a.enrollment_id = b.enrollment_id and a.source_file = b.source_file
WHERE ERROR_TYPE IS NOT NULL 

UNION ALL

SELECT ''ENROLLMENT.CSV'' fileName
,''Length of Stay'' ColumnName
,case when a.enrollment_id is null then ''STG_MD5_HASH_VALUE'' else ''ENROLLMENT_ID'' end ID_FIELD_1
,case when a.enrollment_id is null then a.stg_md5_hash_value else a.enrollment_id end ID_VALUE_1
,case when a.personal_id is null then ''STG_MD5_HASH_VALUE'' else ''PERSONAL_ID'' end ID_FIELD_2
,case when a.personal_id is null then a.stg_md5_hash_value else a.personal_id end ID_VALUE_2
,NULL ID_FIELD_3
,NULL ID_VALUE_3
,a.pstg_row_id
,a.source_file
,error_message
,descr
,''INVALID RESPONSE'' ERROR_TYPE
,current_date() as date_loaded, PRIORITIZATION
FROM enrollment a
JOIN error_tbl b ON coalesce(a.enrollment_id,a.stg_md5_hash_value)= b.business_key_value and a.source_file = b.source_file and b.query_name in (''ENROLLMENT_157'', ''ENROLLMENT_158'', ''ENROLLMENT_159'',''ENROLLMENT_29'',''ENROLLMENT_81'',''ENROLLMENT_160'',''ENROLLMENT_161'')

UNION ALL

SELECT ''ENROLLMENT.CSV'' fileName
,''Length of Stay'' ColumnName
,case when a.enrollment_id is null then ''STG_MD5_HASH_VALUE'' else ''ENROLLMENT_ID'' end ID_FIELD_1
,case when a.enrollment_id is null then a.stg_md5_hash_value else a.enrollment_id end ID_VALUE_1
,case when a.personal_id is null then ''STG_MD5_HASH_VALUE'' else ''PERSONAL_ID'' end ID_FIELD_2
,case when a.personal_id is null then a.stg_md5_hash_value else a.personal_id end ID_VALUE_2
,NULL ID_FIELD_3
,NULL ID_VALUE_3
,a.pstg_row_id
,a.source_file
,CASE WHEN LENGTH_OF_STAY = 99 THEN ''DATA NOT COLLECTED INDICATED FOR THE PRIOR LIVING SITUATION LENGTH_OF_STAY COLUMN.''
WHEN LENGTH_OF_STAY IN (8,9) THEN ''CLIENT DOESN''''T KNOW OR PREFERS NOT TO ANSWER INDICATED FOR THE PRIOR LIVING SITUATION LENGTH_OF_STAY COLUMN.'' END error_message
,CASE WHEN LENGTH_OF_STAY = 99 THEN ''PRIOR LIVING SITUATION LENGTH_OF_STAY = 99'' 
WHEN LENGTH_OF_STAY IN (8,9) THEN ''PRIOR LIVING SITUATION LENGTH_OF_STAY IN (8,9)'' end as descr
,CASE WHEN LENGTH_OF_STAY = 99 THEN ''DATA NOT COLLECTED''
WHEN LENGTH_OF_STAY IN (8,9) THEN ''CLIENT DOESN''''T KNOW'' END AS ERROR_TYPE 
,current_date() as date_loaded,''''  PRIORITIZATION
FROM enrollment a
WHERE ERROR_TYPE IS NOT NULL
 )
select
upper(filename) filename
,upper(dataelement) dataelement
,id_field_1
,id_value_1
,id_field_2
,id_value_2
,id_field_3
,id_value_3
,pstg_row_id
,source_file
,upper(error_message) error_message
,upper(descr) descr
,error_type
,date_loaded, PRIORITIZATION
from base
;

-- Return message to confirm that the table has been refreshed
RETURN ''Target tables refreshed successfully.'';
END;
';